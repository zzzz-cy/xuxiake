{"version":3,"file":"useSingle.js","sources":["../../../src/date-picker/hooks/useSingle.tsx"],"sourcesContent":["import { ref, computed, watch } from 'vue';\nimport { CalendarIcon as TdCalendarIcon } from 'tdesign-icons-vue-next';\nimport dayjs from 'dayjs';\nimport omit from 'lodash/omit';\n\nimport { useTNodeJSX } from '../../hooks/tnode';\nimport { useDisabled } from '../../hooks/useDisabled';\nimport { usePrefixClass } from '../../hooks/useConfig';\nimport { useGlobalIcon } from '../../hooks/useGlobalIcon';\nimport { TdDatePickerProps, DateValue } from '../type';\nimport {\n  isValidDate,\n  formatDate,\n  formatTime,\n  getDefaultFormat,\n  parseToDayjs,\n} from '../../_common/js/date-picker/format';\nimport useSingleValue from './useSingleValue';\nimport { useReadonly } from '../../hooks/useReadonly';\n\nexport default function useSingle(props: TdDatePickerProps) {\n  const COMPONENT_NAME = usePrefixClass('date-picker');\n  const { CalendarIcon } = useGlobalIcon({ CalendarIcon: TdCalendarIcon });\n  const disabled = useDisabled();\n  const renderTNodeJSX = useTNodeJSX();\n\n  const inputRef = ref();\n  const isReadOnly = useReadonly();\n\n  const { value, onChange, time, month, year, cacheValue } = useSingleValue(props);\n\n  const formatRef = computed(() =>\n    getDefaultFormat({\n      mode: props.mode,\n      format: props.format,\n      valueType: props.valueType,\n      enableTimePicker: props.enableTimePicker,\n    }),\n  );\n\n  const popupVisible = ref(false);\n  const isHoverCell = ref(false);\n  // 未真正选中前可能不断变更输入框的内容\n  const inputValue = ref(formatDate(value.value, { format: formatRef.value.format }));\n\n  // input 设置\n  const inputProps = computed(() => ({\n    ...props.inputProps,\n    size: props.size,\n    ref: inputRef,\n    prefixIcon: () => renderTNodeJSX('prefixIcon'),\n    readonly: isReadOnly.value || !props.allowInput,\n    suffixIcon: () => {\n      return renderTNodeJSX('suffixIcon') || <CalendarIcon />;\n    },\n    class: [\n      {\n        [`${COMPONENT_NAME.value}__input--placeholder`]: isHoverCell.value,\n      },\n    ],\n    onClear: (context: { e: InputEvent }) => {\n      context?.e?.stopPropagation();\n      popupVisible.value = false;\n      onChange?.('', { dayjsValue: dayjs(), trigger: 'clear' });\n    },\n    onBlur: (val: string, context: { e: FocusEvent }) => {\n      props.onBlur?.({ value: val, e: context.e });\n    },\n    onFocus: (_: string, { e }: { e: FocusEvent }) => {\n      props.onFocus?.({ value: value.value, e });\n    },\n    onChange: (val: string) => {\n      // 输入事件\n      inputValue.value = val;\n\n      // 跳过不符合格式化的输入框内容\n      if (!isValidDate(val, formatRef.value.format)) return;\n      cacheValue.value = val;\n      const newMonth = parseToDayjs(val, formatRef.value.format).month();\n      const newYear = parseToDayjs(val, formatRef.value.format).year();\n      const newTime = formatTime(val, formatRef.value.format, formatRef.value.timeFormat, props.defaultTime);\n      !Number.isNaN(newYear) && (year.value = newYear);\n      !Number.isNaN(newMonth) && (month.value = newMonth);\n      !Number.isNaN(newTime) && (time.value = newTime);\n    },\n    onEnter: (val: string) => {\n      if (!val) {\n        onChange('', { dayjsValue: dayjs(), trigger: 'enter' });\n        popupVisible.value = false;\n        return;\n      }\n\n      if (!isValidDate(val, formatRef.value.format) && !isValidDate(value.value, formatRef.value.format)) return;\n\n      popupVisible.value = false;\n      if (isValidDate(val, formatRef.value.format)) {\n        onChange?.(\n          formatDate(val, { format: formatRef.value.format, targetFormat: formatRef.value.valueType }) as DateValue,\n          {\n            dayjsValue: parseToDayjs(val, formatRef.value.format),\n            trigger: 'enter',\n          },\n        );\n      } else if (isValidDate(value.value, formatRef.value.format)) {\n        inputValue.value = formatDate(value.value, {\n          format: formatRef.value.format,\n        });\n      } else {\n        inputValue.value = '';\n      }\n    },\n  }));\n  // popup 设置\n  const popupProps = computed(() => ({\n    expandAnimation: true,\n    ...omit(props.popupProps, 'on-visible-change'),\n    disabled: disabled.value,\n    overlayInnerStyle: props.popupProps?.overlayInnerStyle ?? { width: 'auto' },\n    overlayClassName: [props.popupProps?.overlayClassName, `${COMPONENT_NAME.value}__panel-container`],\n    onVisibleChange: (visible: boolean, context: any) => {\n      if (disabled.value) return;\n      // 这里劫持了进一步向 popup 传递的 onVisibleChange 事件，为了保证可以在 Datepicker 中使用 popupProps.onVisibleChange，故此处理\n      props.popupProps?.onVisibleChange?.(visible, context);\n      props.popupProps?.['on-visible-change']?.(visible, context);\n      // 输入框点击不关闭面板\n      if (context.trigger === 'trigger-element-click') {\n        popupVisible.value = true;\n        return;\n      }\n      popupVisible.value = visible;\n    },\n  }));\n\n  watch(value, (value) => {\n    if (!value) {\n      inputValue.value = '';\n      return;\n    }\n    if (!isValidDate(value, formatRef.value.format)) return;\n\n    inputValue.value = formatDate(value, {\n      format: formatRef.value.format,\n    });\n  });\n\n  return {\n    year,\n    month,\n    value,\n    time,\n    inputValue,\n    popupVisible,\n    inputProps,\n    popupProps,\n    inputRef,\n    cacheValue,\n    isHoverCell,\n    onChange,\n  };\n}\n"],"names":["useSingle","props","COMPONENT_NAME","usePrefixClass","_useGlobalIcon","useGlobalIcon","CalendarIcon","TdCalendarIcon","disabled","useDisabled","renderTNodeJSX","useTNodeJSX","inputRef","ref","isReadOnly","useReadonly","_useSingleValue","useSingleValue","value","onChange","time","month","year","cacheValue","formatRef","computed","getDefaultFormat","mode","format","valueType","enableTimePicker","popupVisible","isHoverCell","inputValue","formatDate","inputProps","_objectSpread","size","prefixIcon","readonly","allowInput","suffixIcon","_createVNode","_defineProperty","concat","onClear","context","_context$e","e","stopPropagation","dayjsValue","dayjs","trigger","onBlur","val","_props$onBlur","call","onFocus","_","_ref2","_props$onFocus","isValidDate","newMonth","parseToDayjs","newYear","newTime","formatTime","timeFormat","defaultTime","Number","isNaN","onEnter","targetFormat","popupProps","_props$popupProps$ove","_props$popupProps","_props$popupProps2","expandAnimation","omit","overlayInnerStyle","width","overlayClassName","onVisibleChange","visible","_props$popupProps3","_props$popupProps3$on","_props$popupProps4","_props$popupProps4$on","watch"],"mappings":"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"}